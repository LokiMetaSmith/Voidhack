<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCARS Terminal</title>
    <link rel="icon" href="data:,">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap');

        :root {
            --lcars-orange: #ff9900;
            --lcars-purple: #cc99cc;
            --lcars-blue: #9999ff;
            --lcars-red: #cc0000;
            --lcars-bg: #000000;
            --lcars-text: #000000;
            --lcars-light-text: #ff9900;
        }

        body {
            background-color: var(--lcars-bg);
            color: var(--lcars-orange);
            font-family: 'Antonio', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* LCARS Layout */
        .lcars-container {
            display: grid;
            grid-template-columns: 150px 1fr;
            grid-template-rows: 100px 1fr 50px;
            height: 100%;
            gap: 10px;
            padding: 10px;
        }

        /* Header */
        .lcars-header {
            grid-column: 1 / -1;
            background-color: var(--lcars-purple);
            border-radius: 0 0 0 50px; /* The curve */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 20px;
            font-size: 48px;
            font-weight: bold;
            color: var(--lcars-text);
            text-transform: uppercase;
        }

        /* Sidebar */
        .lcars-sidebar {
            grid-column: 1;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .lcars-button {
            background-color: var(--lcars-blue);
            color: var(--lcars-text);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 30px 0 0 30px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .lcars-button:hover {
            background-color: #ddddff;
        }

        .lcars-button.active {
            background-color: var(--lcars-orange);
        }

        .lcars-spacer {
            flex-grow: 1;
            background-color: var(--lcars-bg);
        }

        .lcars-elbow {
            height: 100px;
            background-color: var(--lcars-purple);
            border-radius: 0 0 0 50px;
        }

        /* Main Content */
        .lcars-main {
            grid-column: 2;
            grid-row: 2;
            border: 2px solid var(--lcars-orange);
            border-radius: 20px; /* Inner screen look */
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            overflow-y: auto;
        }

        .status-panel {
            grid-column: 1 / -1;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
        }

        .system-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }

        .bar-container {
            width: 40px;
            height: 200px;
            background-color: #333;
            position: relative;
            margin-bottom: 10px;
            border: 1px solid var(--lcars-orange);
        }

        .bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--lcars-orange);
            transition: height 0.5s ease-in-out;
        }

        .system-name {
            font-size: 18px;
            text-transform: uppercase;
        }

        .system-value {
            font-size: 24px;
            font-weight: bold;
        }

        .log-panel {
            grid-column: 1 / -1;
            border-top: 1px solid var(--lcars-orange);
            padding-top: 10px;
            font-family: monospace;
            color: var(--lcars-light-text);
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry.system {
            color: #999999;
            font-size: 0.9em;
        }

        .log-entry.chat {
            color: var(--lcars-orange);
            font-weight: bold;
        }

        .log-panel.hide-system .log-entry.system {
            display: none;
        }

        /* Footer */
        .lcars-footer {
            grid-column: 1 / -1;
            text-align: right;
            color: var(--lcars-orange);
            font-size: 14px;
        }

        #init-btn {
            background-color: var(--lcars-red);
            color: white;
        }

        #listening-indicator {
            display: none;
            color: var(--lcars-red);
            font-weight: bold;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

    </style>
</head>
<body>

    <div class="lcars-container">
        <div class="lcars-header">
            USS ENTERPRISE <span style="margin-left: 20px; font-size: 24px;">NCC-1701-D</span>
        </div>

        <div class="lcars-sidebar">
            <div class="lcars-button" id="init-btn" onclick="initComms()">INIT COMMS</div>
            <div class="lcars-button">MODE</div>
            <div class="lcars-button" id="logs-btn" onclick="toggleLogs()">LOGS</div>
            <div class="lcars-spacer"></div>
            <div class="lcars-elbow"></div>
        </div>

        <div class="lcars-main">
            <div class="status-panel" id="status-panel">
                <!-- Systems generated here -->
            </div>

            <div style="grid-column: 1/-1; text-align: center;">
                <h2 id="listening-indicator">LISTENING...</h2>
                <p id="last-command">Awaiting input...</p>
            </div>

            <div class="log-panel" id="log-panel">
                SYSTEM READY.
            </div>
        </div>

        <div class="lcars-footer">
            LCARS 47983.2
        </div>
    </div>

    <!-- Silent Audio Loop for Hack -->
    <audio id="silent-audio" loop>
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
    </audio>

    <script>
        const API_URL = window.location.origin;
        const silentAudio = document.getElementById('silent-audio');
        const logPanel = document.getElementById('log-panel');
        let recognition;

        // State Flags
        let isMicActive = false;
        let commandWindowEnd = 0; // Timestamp: ignore speech after this time
        let showSystemLogs = true;
        let wakeLock = null; // Added back
        let isOnboarding = false; // Flag for first-time user setup

        // Profiling
        let t_trigger = 0;

        // Audio Context for Chirp
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function toggleLogs() {
            showSystemLogs = !showSystemLogs;
            const btn = document.getElementById('logs-btn');
            if (showSystemLogs) {
                logPanel.classList.remove('hide-system');
                btn.classList.remove('active');
            } else {
                logPanel.classList.add('hide-system');
                btn.classList.add('active');
            }
        }

        function playChirp() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(e => console.warn("AudioContext resume failed", e));
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.1);

            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        // --- WAKE LOCK (Re-added) ---
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                log("Screen Wake Lock active.", "system");
                document.addEventListener('visibilitychange', async () => {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        wakeLock = await navigator.wakeLock.request('screen');
                    }
                });
            } catch (err) {
                log(`Wake Lock Error: ${err.name}`, "error");
            }
        }

        function triggerFeedback() {
            // Audio Chirp (Requested)
            playChirp();

            // Tactile Feedback
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            document.getElementById('listening-indicator').style.display = 'block';
        }

        function log(msg, type = 'system') {
            requestAnimationFrame(() => {
                const line = document.createElement('div');
                line.className = `log-entry ${type}`;
                line.textContent = `> ${msg}`;
                logPanel.appendChild(line);
                logPanel.scrollTop = logPanel.scrollHeight;
            });
        }

        // --- MAIN INITIALIZATION ---
        async function initComms() {
            try {
                await requestWakeLock(); // Re-added

                // Resume audio context on user gesture
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }

                // 1. Start Silent Loop (Keeps Media Session alive)
                await silentAudio.play();
                log("Comms Initialized. Silent loop active.", "system");

                const initBtn = document.getElementById('init-btn');
                initBtn.textContent = "ACTIVE";
                initBtn.style.backgroundColor = "#9999ff";

                // 2. Setup Media Session (Headset Button)
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: 'LCARS Comms',
                        artist: 'Enterprise Computer',
                        album: 'Main Bridge'
                    });
                    const actionHandler = () => handleHeadsetTrigger();
                    navigator.mediaSession.setActionHandler('pause', actionHandler);
                    navigator.mediaSession.setActionHandler('play', actionHandler);
                }

                // 3. Start "Hot Mic" immediately
                setupSpeechRecognition();
                startContinuousMic();

                // 4. Check Onboarding Status
                const savedHandle = localStorage.getItem('lcars_handle');
                if (!savedHandle) {
                    isOnboarding = true;
                    // Prompt user after a brief delay to ensure systems are ready
                    setTimeout(() => {
                        speak("Communication link established. Please state your identity.");
                    }, 1000);
                } else {
                     log(`Identity confirmed: ${savedHandle}`, "system");
                }

            } catch (err) {
                log("Error initializing comms: " + err, "error");
            }
        }

        // --- LOGIC: THE "GATE" ---
        function handleHeadsetTrigger() {
            t_trigger = performance.now();

            // Open the "Listening Window" for 5 seconds
            commandWindowEnd = Date.now() + 5000;

            triggerFeedback();
            log("Channel Open. Waiting for input...", "system");

            // Ensure silent audio resumes if the OS paused it
            if (silentAudio.paused) {
                 silentAudio.play().catch(e => {});
            }
        }

        // --- SPEECH RECOGNITION (ALWAYS ON) ---
        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                log("Web Speech API not supported.");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;  // Keep listening
            recognition.interimResults = true; // Get data faster
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isMicActive = true;
                log("Microphone Hot. Background monitoring active.", "system");
            };

            recognition.onend = () => {
                isMicActive = false;
                // AUTO-RESTART: Keep the mic hot!
                // Note: We delay slightly to avoid CPU thrashing if it crashes instantly
                setTimeout(() => {
                    if (document.visibilityState === 'visible') {
                        startContinuousMic();
                    }
                }, 100);
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let isFinal = false;

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                        isFinal = true;
                    }
                }

                // FILTER: Only process if the "Button Gate" is open
                if (isFinal && finalTranscript.trim().length > 0) {
                    if (Date.now() < commandWindowEnd) {
                        // Valid Command
                        log(`Heard: "${finalTranscript}"`, "chat");
                        document.getElementById('last-command').textContent = finalTranscript;

                        // Close the gate immediately after hearing a command
                        commandWindowEnd = 0;
                        document.getElementById('listening-indicator').style.display = 'none';

                        if (isOnboarding) {
                            // Handle Onboarding Response
                            localStorage.setItem('lcars_handle', finalTranscript);
                            isOnboarding = false;
                            speak(`Identity confirmed, ${finalTranscript}. Systems online.`);
                            log(`User handle saved: ${finalTranscript}`, "system");
                        } else {
                            // Normal Command
                            sendCommand(finalTranscript);
                        }
                    } else {
                        // Ignored (Background noise / Hot Mic buffer)
                        // log(`(Ignored): "${finalTranscript}"`, "system");
                    }
                }
            };

            recognition.onerror = (event) => {
                if (event.error !== 'no-speech') {
                    log("Speech Error: " + event.error, "error");
                }
            };
        }

        function startContinuousMic() {
            if (recognition && !isMicActive) {
                try {
                    recognition.start();
                } catch (e) {
                    // Ignore "already started" errors
                }
            }
        }

        // --- BACKEND COMMUNICATION ---
        async function sendCommand(text) {
            // Pause Mic while Computer speaks to prevent it hearing itself
            if(recognition) recognition.stop();

            try {
                const res = await fetch(API_URL + '/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                const data = await res.json();
                log("Computer: " + data.response, "chat");
                speak(data.response);
                updateStatusUI(data.updates);
            } catch (err) {
                log("Backend Error: " + err, "error");
                speak("Communication Link Severed.");
            }
        }

        // --- TTS (Optimized) ---
        function speak(text) {
            window.speechSynthesis.cancel(); // Clear queue

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.1;

            utterance.onend = () => {
                // RE-START MIC after computer finishes speaking
                startContinuousMic();
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- STATUS POLLING (Unchanged) ---
        async function pollStatus() {
            if (window.location.protocol === 'file:') return;
            try {
                const res = await fetch(API_URL + '/status');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                renderSystems(data.systems);
            } catch (e) { console.log("Poll error", e); }
            setTimeout(pollStatus, 5000);
        }

        function updateStatusUI(updates) {
            renderSystems(updates);
        }

        function renderSystems(systems) {
            const panel = document.getElementById('status-panel');
            // Only clear if empty to avoid flickering, or use diffing.
            // For simplicity, we'll just update values if elements exist.

            if (panel.children.length === 0) {
                // Initial render
                for (const [name, level] of Object.entries(systems)) {
                    const div = document.createElement('div');
                    div.className = 'system-display';
                    div.id = `sys-${name}`;
                    div.innerHTML = `
                        <div class="bar-container">
                            <div class="bar-fill" style="height: ${level}%"></div>
                        </div>
                        <div class="system-name">${name}</div>
                        <div class="system-value">${level}%</div>
                    `;
                    panel.appendChild(div);
                }
            } else {
                // Update
                for (const [name, level] of Object.entries(systems)) {
                    const el = document.getElementById(`sys-${name}`);
                    if (el) {
                        el.querySelector('.bar-fill').style.height = `${level}%`;
                        el.querySelector('.system-value').textContent = `${level}%`;
                    }
                }
            }
        }

        // Initial load
        pollStatus();

    </script>
</body>
</html>
