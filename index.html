<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCARS Terminal</title>
    <link rel="icon" href="data:,">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap');

        :root {
            --lcars-orange: #ff9900;
            --lcars-purple: #cc99cc;
            --lcars-blue: #9999ff;
            --lcars-red: #cc0000;
            --lcars-bg: #000000;
            --lcars-text: #000000;
            --lcars-light-text: #ff9900;
        }

        body {
            background-color: var(--lcars-bg);
            color: var(--lcars-orange);
            font-family: 'Antonio', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* LCARS Layout */
        .lcars-container {
            display: grid;
            grid-template-columns: 150px 1fr;
            grid-template-rows: 100px 1fr 50px;
            height: 100%;
            gap: 10px;
            padding: 10px;
        }

        /* Header */
        .lcars-header {
            grid-column: 1 / -1;
            background-color: var(--lcars-purple);
            border-radius: 0 0 0 50px; /* The curve */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 20px;
            font-size: 48px;
            font-weight: bold;
            color: var(--lcars-text);
            text-transform: uppercase;
        }

        /* Sidebar */
        .lcars-sidebar {
            grid-column: 1;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .lcars-button {
            background-color: var(--lcars-blue);
            color: var(--lcars-text);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 30px 0 0 30px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .lcars-button:hover {
            background-color: #ddddff;
        }

        .lcars-button.active {
            background-color: var(--lcars-orange);
        }

        .lcars-spacer {
            flex-grow: 1;
            background-color: var(--lcars-bg);
        }

        .lcars-elbow {
            height: 100px;
            background-color: var(--lcars-purple);
            border-radius: 0 0 0 50px;
        }

        /* Main Content */
        .lcars-main {
            grid-column: 2;
            grid-row: 2;
            border: 2px solid var(--lcars-orange);
            border-radius: 20px; /* Inner screen look */
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            overflow-y: auto;
        }

        .status-panel {
            grid-column: 1 / -1;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
        }

        .system-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }

        .bar-container {
            width: 40px;
            height: 200px;
            background-color: #333;
            position: relative;
            margin-bottom: 10px;
            border: 1px solid var(--lcars-orange);
        }

        .bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--lcars-orange);
            transition: height 0.5s ease-in-out;
        }

        .system-name {
            font-size: 18px;
            text-transform: uppercase;
        }

        .system-value {
            font-size: 24px;
            font-weight: bold;
        }

        .log-panel {
            grid-column: 1 / -1;
            border-top: 1px solid var(--lcars-orange);
            padding-top: 10px;
            font-family: monospace;
            color: var(--lcars-light-text);
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry.system {
            color: #999999;
            font-size: 0.9em;
        }

        .log-entry.chat {
            color: var(--lcars-orange);
            font-weight: bold;
        }

        .log-panel.hide-system .log-entry.system {
            display: none;
        }

        /* Footer */
        .lcars-footer {
            grid-column: 1 / -1;
            text-align: right;
            color: var(--lcars-orange);
            font-size: 14px;
        }

        #init-btn {
            background-color: var(--lcars-red);
            color: white;
        }

        #listening-indicator {
            display: none;
            color: var(--lcars-red);
            font-weight: bold;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            /* Tablet */
            .lcars-container {
                grid-template-columns: 120px 1fr;
            }
            .lcars-header {
                font-size: 36px;
            }
        }

        @media (max-width: 768px) {
            /* Mobile */
            .lcars-container {
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow-y: auto;
                gap: 5px;
            }

            .lcars-header {
                height: 60px;
                font-size: 24px;
                border-radius: 0 0 0 20px;
                padding-right: 10px;
            }

            .lcars-sidebar {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 5px;
                height: auto;
                order: 3; /* Move to bottom on mobile */
                padding-bottom: 10px;
            }

            .lcars-button {
                flex: 1;
                height: 50px;
                font-size: 16px;
                border-radius: 10px;
                justify-content: center;
                padding-right: 0;
            }

            .lcars-spacer, .lcars-elbow {
                display: none;
            }

            .lcars-main {
                order: 2;
                border-radius: 10px;
                padding: 10px;
                grid-template-columns: 1fr;
                overflow-y: visible;
                flex-grow: 1;
            }

            .status-panel {
                gap: 10px;
            }

            .system-display {
                width: 80px;
            }

            .bar-container {
                width: 30px;
                height: 150px;
            }

            .system-name {
                font-size: 14px;
            }

            .system-value {
                font-size: 18px;
            }

            .lcars-footer {
                order: 4;
                text-align: center;
                padding: 5px;
            }
        }

    </style>
</head>
<body>

    <div class="lcars-container">
        <div class="lcars-header">
            USS ENTERPRISE <span style="margin-left: 20px; font-size: 24px;">NCC-1701-D</span>
        </div>

        <div class="lcars-sidebar">
            <div class="lcars-button" id="init-btn" onclick="initComms()">INIT COMMS</div>
            <div class="lcars-button">MODE</div>
            <div class="lcars-button" id="logs-btn" onclick="toggleLogs()">LOGS</div>
            <div class="lcars-spacer"></div>
            <div class="lcars-elbow"></div>
        </div>

        <div class="lcars-main">
            <div class="status-panel" id="status-panel">
                <!-- Systems generated here -->
            </div>

            <div style="grid-column: 1/-1; text-align: center;">
                <h2 id="listening-indicator">LISTENING...</h2>
                <p id="last-command">Awaiting input...</p>
            </div>

            <div class="log-panel" id="log-panel">
                SYSTEM READY.
            </div>
        </div>

        <div class="lcars-footer">
            LCARS 47983.2
        </div>
    </div>

    <!-- Silent Audio Loop for Hack -->
    <audio id="silent-audio" loop>
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
    </audio>

    <script>
        const API_URL = window.location.origin;
        const silentAudio = document.getElementById('silent-audio');
        const logPanel = document.getElementById('log-panel');
        let recognition;
        let isListening = false;
        let isStarting = false;
        let showSystemLogs = true;

        // Profiling timestamps
        let t_trigger = 0;
        let t_speak_req = 0;

        function toggleLogs() {
            showSystemLogs = !showSystemLogs;
            const btn = document.getElementById('logs-btn');
            if (showSystemLogs) {
                logPanel.classList.remove('hide-system');
                btn.classList.remove('active');
            } else {
                logPanel.classList.add('hide-system');
                btn.classList.add('active');
            }
        }

        // Chirp sound (simple beep/chirp using oscillator)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playChirp() {
            if (audioCtx.state === 'suspended') {
                // This might fail if not triggered by user interaction
                audioCtx.resume().catch(e => console.warn("AudioContext resume failed", e));
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.1);

            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        // Pre-load voices to avoid blocking later
        window.speechSynthesis.getVoices();
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = () => { window.speechSynthesis.getVoices(); };
        }

        function log(msg, type = 'system') {
            // Use requestAnimationFrame to batch DOM updates and avoid layout thrashing
            requestAnimationFrame(() => {
                const line = document.createElement('div');
                line.className = `log-entry ${type}`;
                line.textContent = `> ${msg}`;
                logPanel.appendChild(line);
                logPanel.scrollTop = logPanel.scrollHeight;
            });
        }

        async function initComms() {
            try {
                // Play silent audio to engage Media Session
                await silentAudio.play();
                log("Comms Initialized. Silent loop active.", "system");
                document.getElementById('init-btn').textContent = "ACTIVE";
                document.getElementById('init-btn').style.backgroundColor = "#9999ff";

                // Setup Media Session API Hack
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: 'LCARS Comms',
                        artist: 'Enterprise Computer',
                        album: 'Main Bridge'
                    });

                    const actionHandler = () => {
                        log("Headset button detected!", "system");
                        handleHeadsetTrigger();
                    };

                    // We listen for 'pause' because tapping a headset button usually pauses playing media
                    navigator.mediaSession.setActionHandler('pause', actionHandler);
                    // Also listen for 'play' in case it toggles
                    navigator.mediaSession.setActionHandler('play', actionHandler);
                } else {
                    log("Media Session API not supported.", "error");
                }

                setupSpeechRecognition();
                // pollStatus() is already running from initial load

            } catch (err) {
                log("Error initializing comms: " + err, "error");
            }
        }

        function handleHeadsetTrigger() {
            if (isListening || isStarting) return; // Debounce

            t_trigger = performance.now();
            startListening();

            // Resume silent audio after a moment so we are ready for next tap
            // If we pause immediately, the browser might not let us resume without user gesture?
            // Actually, since we are in the event handler of a media key, we are 'blessed'
            setTimeout(() => {
                silentAudio.play().catch(e => console.log("Resume silent fail", e));
            }, 500);
        }

        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                log("Web Speech API not supported.");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                const t_start = performance.now();
                const latency = (t_start - t_trigger).toFixed(2);
                isListening = true;
                isStarting = false;
                playChirp();
                document.getElementById('listening-indicator').style.display = 'block';
                log(`Listening... (Wake Latency: ${latency}ms)`, "system");
            };

            recognition.onend = () => {
                isListening = false;
                isStarting = false;
                document.getElementById('listening-indicator').style.display = 'none';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                log(`Heard: "${transcript}"`, "chat");
                document.getElementById('last-command').textContent = transcript;
                sendCommand(transcript);
            };

            recognition.onerror = (event) => {
                // Ignore no-speech error as it's common
                if (event.error !== 'no-speech') {
                    log("Speech Error: " + event.error, "error");
                }
                isListening = false;
                isStarting = false;
            };
        }

        function startListening() {
            if (recognition && !isListening && !isStarting) {
                isStarting = true;

                // Safety timeout: if onstart doesn't fire in 2s, reset
                const safetyTimer = setTimeout(() => {
                    if (isStarting) {
                        log("Microphone init timed out.", "error");
                        isStarting = false;
                    }
                }, 2000);

                try {
                    recognition.start();
                } catch (e) {
                    clearTimeout(safetyTimer);
                    isStarting = false;
                    // If it was already started by race condition, just ignore
                    if (e.name !== 'InvalidStateError') {
                         log("Recog start error: " + e, "error");
                    }
                }
            }
        }

        async function sendCommand(text) {
            console.time('sendCommand');
            try {
                const res = await fetch(API_URL + '/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                const data = await res.json();

                console.timeEnd('sendCommand');
                log("Computer: " + data.response, "chat");
                speak(data.response);
                updateStatusUI(data.updates);

            } catch (err) {
                console.timeEnd('sendCommand');
                log("Backend Error: " + err, "error");
                speak("Communication Link Severed.");
            }
        }

        function speak(text) {
            console.time('speak');
            t_speak_req = performance.now();
            const utterance = new SpeechSynthesisUtterance(text);

            utterance.onstart = () => {
                const t_audio = performance.now();
                const latency = (t_audio - t_speak_req).toFixed(2);
                log(`TTS Latency: ${latency}ms`, "system");
            };

            utterance.onend = () => console.timeEnd('speak');
            // Try to find a robotic voice if possible
            const voices = window.speechSynthesis.getVoices();
            // Just pick the first one for now, user can customize
            window.speechSynthesis.speak(utterance);
        }

        let lastErrorMsg = "";

        async function pollStatus() {
            // Avoid polling if opened via file:// protocol as it will fail
            if (window.location.protocol === 'file:') {
                console.warn("Running from file:// protocol. Backend features disabled.");
                log("Warning: Running from file system. Backend unreachable.");
                return;
            }

            try {
                const res = await fetch(API_URL + '/status');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                renderSystems(data.systems);
                lastErrorMsg = ""; // Clear error state on success
            } catch (e) {
                console.log("Poll error", e);
                const errMsg = `Status Poll Failed: ${e.message}`;
                if (errMsg !== lastErrorMsg) {
                    log(errMsg, "error");
                    lastErrorMsg = errMsg;
                }
            } finally {
                // Ensure we ALWAYS schedule the next poll, even if this one failed
                setTimeout(pollStatus, 10000);
            }
        }

        function updateStatusUI(updates) {
            // Optimistically update the UI to avoid creating multiple polling loops
            renderSystems(updates);
        }

        function renderSystems(systems) {
            const panel = document.getElementById('status-panel');
            // Only clear if empty to avoid flickering, or use diffing.
            // For simplicity, we'll just update values if elements exist.

            if (panel.children.length === 0) {
                // Initial render
                for (const [name, level] of Object.entries(systems)) {
                    const div = document.createElement('div');
                    div.className = 'system-display';
                    div.id = `sys-${name}`;
                    div.innerHTML = `
                        <div class="bar-container">
                            <div class="bar-fill" style="height: ${level}%"></div>
                        </div>
                        <div class="system-name">${name}</div>
                        <div class="system-value">${level}%</div>
                    `;
                    panel.appendChild(div);
                }
            } else {
                // Update
                for (const [name, level] of Object.entries(systems)) {
                    const el = document.getElementById(`sys-${name}`);
                    if (el) {
                        el.querySelector('.bar-fill').style.height = `${level}%`;
                        el.querySelector('.system-value').textContent = `${level}%`;
                    }
                }
            }
        }

        // Initial load
        pollStatus();

    </script>
</body>
</html>
