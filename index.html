<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCARS Terminal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap');

        :root {
            --lcars-orange: #ff9900;
            --lcars-purple: #cc99cc;
            --lcars-blue: #9999ff;
            --lcars-red: #cc0000;
            --lcars-bg: #000000;
            --lcars-text: #000000;
            --lcars-light-text: #ff9900;
        }

        body {
            background-color: var(--lcars-bg);
            color: var(--lcars-orange);
            font-family: 'Antonio', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* LCARS Layout */
        .lcars-container {
            display: grid;
            grid-template-columns: 150px 1fr;
            grid-template-rows: 100px 1fr 50px;
            height: 100%;
            gap: 10px;
            padding: 10px;
        }

        /* Header */
        .lcars-header {
            grid-column: 1 / -1;
            background-color: var(--lcars-purple);
            border-radius: 0 0 0 50px; /* The curve */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 20px;
            font-size: 48px;
            font-weight: bold;
            color: var(--lcars-text);
            text-transform: uppercase;
        }

        /* Sidebar */
        .lcars-sidebar {
            grid-column: 1;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .lcars-button {
            background-color: var(--lcars-blue);
            color: var(--lcars-text);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 30px 0 0 30px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .lcars-button:hover {
            background-color: #ddddff;
        }

        .lcars-button.active {
            background-color: var(--lcars-orange);
        }

        .lcars-spacer {
            flex-grow: 1;
            background-color: var(--lcars-bg);
        }

        .lcars-elbow {
            height: 100px;
            background-color: var(--lcars-purple);
            border-radius: 0 0 0 50px;
        }

        /* Main Content */
        .lcars-main {
            grid-column: 2;
            grid-row: 2;
            border: 2px solid var(--lcars-orange);
            border-radius: 20px; /* Inner screen look */
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            overflow-y: auto;
        }

        .status-panel {
            grid-column: 1 / -1;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
        }

        .system-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }

        .bar-container {
            width: 40px;
            height: 200px;
            background-color: #333;
            position: relative;
            margin-bottom: 10px;
            border: 1px solid var(--lcars-orange);
        }

        .bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--lcars-orange);
            transition: height 0.5s ease-in-out;
        }

        .system-name {
            font-size: 18px;
            text-transform: uppercase;
        }

        .system-value {
            font-size: 24px;
            font-weight: bold;
        }

        .log-panel {
            grid-column: 1 / -1;
            border-top: 1px solid var(--lcars-orange);
            padding-top: 10px;
            font-family: monospace;
            color: var(--lcars-light-text);
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Footer */
        .lcars-footer {
            grid-column: 1 / -1;
            text-align: right;
            color: var(--lcars-orange);
            font-size: 14px;
        }

        #init-btn {
            background-color: var(--lcars-red);
            color: white;
        }

        #listening-indicator {
            display: none;
            color: var(--lcars-red);
            font-weight: bold;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

    </style>
</head>
<body>

    <div class="lcars-container">
        <div class="lcars-header">
            USS ENTERPRISE <span style="margin-left: 20px; font-size: 24px;">NCC-1701-D</span>
        </div>

        <div class="lcars-sidebar">
            <div class="lcars-button" id="init-btn" onclick="initComms()">INIT COMMS</div>
            <div class="lcars-button">MODE</div>
            <div class="lcars-button">LCARS</div>
            <div class="lcars-spacer"></div>
            <div class="lcars-elbow"></div>
        </div>

        <div class="lcars-main">
            <div class="status-panel" id="status-panel">
                <!-- Systems generated here -->
            </div>

            <div style="grid-column: 1/-1; text-align: center;">
                <h2 id="listening-indicator">LISTENING...</h2>
                <p id="last-command">Awaiting input...</p>
            </div>

            <div class="log-panel" id="log-panel">
                SYSTEM READY.
            </div>
        </div>

        <div class="lcars-footer">
            LCARS 47983.2
        </div>
    </div>

    <!-- Silent Audio Loop for Hack -->
    <audio id="silent-audio" loop>
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
    </audio>

    <script>
        const API_URL = window.location.origin;
        const silentAudio = document.getElementById('silent-audio');
        const logPanel = document.getElementById('log-panel');
        let recognition;
        let isListening = false;

        // Chirp sound (simple beep/chirp using oscillator)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playChirp() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.1);

            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        function log(msg) {
            logPanel.textContent += `\n> ${msg}`;
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        async function initComms() {
            try {
                // Play silent audio to engage Media Session
                await silentAudio.play();
                log("Comms Initialized. Silent loop active.");
                document.getElementById('init-btn').textContent = "ACTIVE";
                document.getElementById('init-btn').style.backgroundColor = "#9999ff";

                // Setup Media Session API Hack
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: 'LCARS Comms',
                        artist: 'Enterprise Computer',
                        album: 'Main Bridge'
                    });

                    const actionHandler = () => {
                        log("Headset button detected!");
                        handleHeadsetTrigger();
                    };

                    // We listen for 'pause' because tapping a headset button usually pauses playing media
                    navigator.mediaSession.setActionHandler('pause', actionHandler);
                    // Also listen for 'play' in case it toggles
                    navigator.mediaSession.setActionHandler('play', actionHandler);
                } else {
                    log("Media Session API not supported.");
                }

                setupSpeechRecognition();
                pollStatus();

            } catch (err) {
                log("Error initializing comms: " + err);
            }
        }

        function handleHeadsetTrigger() {
            if (isListening) return; // Debounce

            playChirp();
            startListening();

            // Resume silent audio after a moment so we are ready for next tap
            // If we pause immediately, the browser might not let us resume without user gesture?
            // Actually, since we are in the event handler of a media key, we are 'blessed'
            setTimeout(() => {
                silentAudio.play().catch(e => console.log("Resume silent fail", e));
            }, 500);
        }

        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                log("Web Speech API not supported.");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                document.getElementById('listening-indicator').style.display = 'block';
                log("Listening...");
            };

            recognition.onend = () => {
                isListening = false;
                document.getElementById('listening-indicator').style.display = 'none';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                log(`Heard: "${transcript}"`);
                document.getElementById('last-command').textContent = transcript;
                sendCommand(transcript);
            };

            recognition.onerror = (event) => {
                log("Speech Error: " + event.error);
                isListening = false;
            };
        }

        function startListening() {
            if (recognition && !isListening) {
                try {
                    recognition.start();
                } catch (e) {
                    log("Recog start error: " + e);
                }
            }
        }

        async function sendCommand(text) {
            try {
                const res = await fetch(API_URL + '/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                const data = await res.json();

                log("Computer: " + data.response);
                speak(data.response);
                updateStatusUI(data.updates);

            } catch (err) {
                log("Backend Error: " + err);
                speak("Communication Link Severed.");
            }
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            // Try to find a robotic voice if possible
            const voices = window.speechSynthesis.getVoices();
            // Just pick the first one for now, user can customize
            window.speechSynthesis.speak(utterance);
        }

        async function pollStatus() {
            try {
                const res = await fetch(API_URL + '/status');
                const data = await res.json();
                renderSystems(data.systems);
            } catch (e) {
                console.log("Poll error", e);
            }
            setTimeout(pollStatus, 5000);
        }

        function updateStatusUI(updates) {
            // We can just wait for poll, or optimistically update.
            // Poll is simpler, but let's trigger a poll immediately.
            pollStatus();
        }

        function renderSystems(systems) {
            const panel = document.getElementById('status-panel');
            // Only clear if empty to avoid flickering, or use diffing.
            // For simplicity, we'll just update values if elements exist.

            if (panel.children.length === 0) {
                // Initial render
                for (const [name, level] of Object.entries(systems)) {
                    const div = document.createElement('div');
                    div.className = 'system-display';
                    div.id = `sys-${name}`;
                    div.innerHTML = `
                        <div class="bar-container">
                            <div class="bar-fill" style="height: ${level}%"></div>
                        </div>
                        <div class="system-name">${name}</div>
                        <div class="system-value">${level}%</div>
                    `;
                    panel.appendChild(div);
                }
            } else {
                // Update
                for (const [name, level] of Object.entries(systems)) {
                    const el = document.getElementById(`sys-${name}`);
                    if (el) {
                        el.querySelector('.bar-fill').style.height = `${level}%`;
                        el.querySelector('.system-value').textContent = `${level}%`;
                    }
                }
            }
        }

        // Initial load
        pollStatus();

    </script>
</body>
</html>
